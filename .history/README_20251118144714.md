# FlashNotify - Déploiement

Ce document décrit les différentes méthodes de déploiement de l'application FlashNotify.

## Architecture

FlashNotify est une application Python qui combine Flask et FastAPI :

- **Flask** : Interface web traditionnelle (port 5000)
- **FastAPI** : API moderne (port 8000)
- **Base de données** : PostgreSQL ou SQLite
- **File d'attente** : Redis
- **Proxy inverse** : Nginx

## Méthodes de déploiement

### 1. Docker (Recommandé)

#### Prérequis
- Docker
- Docker Compose

#### Déploiement avec Docker Compose

```bash
# Lancer l'application complète
docker-compose up -d

# Arrêter l'application
docker-compose down

# Voir les logs
docker-compose logs -f
```

#### Déploiement avec le script de déploiement

```bash
# Déploiement en développement (par défaut)
./deploy.sh

# Déploiement en staging
./deploy.sh staging

# Déploiement en production
./deploy.sh prod

# Reconstruction de l'image
./deploy.sh dev -r
```

### 2. Déploiement manuel

#### Prérequis
- Python 3.11+
- PostgreSQL
- Redis

#### Installation

```bash
# Installation des dépendances
pip install -r requirements.txt

# Initialisation de la base de données
python -c "from app import init_db; init_db()"

# Lancement de l'API FastAPI
python run_fastapi.py

# Lancement de l'application Flask
python app.py
```

## Configuration

### Variables d'environnement

| Variable | Description | Valeur par défaut |
|----------|-------------|-------------------|
| `DATABASE_URL` | URL de la base de données | `sqlite:///./flashnotify.db` |
| `REDIS_URL` | URL de Redis | `redis://localhost:6379/0` |
| `SESSION_SECRET` | Clé secrète pour les sessions | `dev-secret-key-change-in-production` |
| `FASTAPI_PORT` | Port pour l'API FastAPI | `8000` |
| `FLASK_PORT` | Port pour l'application Flask | `5000` |
| `ENVIRONMENT` | Environnement (dev/staging/prod) | `dev` |

### Fichiers d'environnement

Vous pouvez créer des fichiers `.env.dev`, `.env.staging`, `.env.prod` pour chaque environnement.

## Mise à jour

### Mise à jour avec Docker

```bash
# Récupérer les dernières modifications
git pull

# Reconstruire l'image et redémarrer
docker-compose up -d --build
```

### Mise à jour manuelle

```bash
# Récupérer les dernières modifications
git pull

# Mettre à jour les dépendances
pip install -r requirements.txt

# Redémarrer l'application
```

## Surveillance

### Accès aux logs

Avec Docker Compose :
```bash
docker-compose logs -f app
docker-compose logs -f db
docker-compose logs -f redis
```

### Points d'extrémité de surveillance

- `/api/v2/health/` : Vérification de santé de l'API
- `/docs` : Documentation interactive de l'API
- `/redoc` : Documentation alternative de l'API

## Sécurité

- Le script de déploiement crée un utilisateur non root dans le conteneur
- Les mots de passe et clés secrètes doivent être configurés via des variables d'environnement
- Nginx est configuré avec SSL/TLS (certificats dans `./ssl/`)

## Sauvegardes

### Sauvegarde de la base de données

```bash
# Sauvegarde avec Docker
docker-compose exec db pg_dump -U flashnotify flashnotify > backup.sql

# Restauration
cat backup.sql | docker-compose exec -T db psql -U flashnotify flashnotify
```

## Dépannage

### Problèmes courants

1. **Port déjà utilisé** : Vérifiez que les ports 8000, 5000, 5432, 6379 ne sont pas utilisés
2. **Connexion à la base de données échouée** : Vérifiez la variable `DATABASE_URL`
3. **Problèmes de permissions** : Assurez-vous que le script de déploiement est exécutable (`chmod +x deploy.sh`)

### Commandes utiles

```bash
# Vérifier l'état des conteneurs
docker-compose ps

# Voir les logs en temps réel
docker-compose logs -f

# Exécuter des commandes dans le conteneur
docker-compose exec app python -c "print('Test')"
